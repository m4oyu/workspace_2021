# ISUCON11 Prior note
スライド : https://speakerdeck.com/rosylilly/isucon-11-prior

<br/>

# 0時間目~
## 大会開始時
- 開始位置時間はマニュアル読み、アプリケーションについての理解
- ER図書いて整理など
- キャッシュの処理（Redisなど）
  - 一秒でキャッシュを飛ばすにはkeyにunix time stanpを入れればよさそう

# 1時間目~
## マニュアルを呼んだあと
- 割り当てられたサーバの状態
  - CPU:      cat/proc/cpuinfo
  - memory:   free -h
  - service:  systemctl list-units --type=service --state=running
- 参考実装をgit管理にする
  - git init して git add . && git commit -m "initial state"
- とりあえず最初にベンチマークを実行する
- 戻れるようにしておくことが大事
  - nginxやMySQLのconfファイルをリポジトリ内に入れる
  - リポジトリ内にコピーして、もとの場所にはシンボリックリンクを置く

# 2時間目~
## benchmarkを実行する前・後
- ベンチマーク実行前にはリポジトリをクリーンにしておく
- 実行後はスコアやログをissueに貼っておく
  - どのコミット時点なのかも記録する（戻ってそこからブランチ切れる）

## benchmarkの指標
- １コミット１ベンチでいい
- CPU占有率の高いプロセスがないか
- アクセスログにどんなアクセスが記録されているか
- データベースに発行されているクエリはなにか
- 各種リソースはベンチマーク実行中どう使われているか
  - CPU、メモリ、帯域、IO

### CPU占有率の高いプロセスの特定
- top, htopが便利
- ベンチマークは一分とかなのでずっと眺めていてもよい

### アクセスログの解析
- alpが便利
- 主に見るべきはavgとcount
  - avg：重い処理を特定
  - count：よく来るリクエストを特定（キャッシュで対処できるかも？）

### データベースのクエリを洗う
- newlelic?
- mysql -> slow_query_log

### アプリケーションのログを出す
- 特定のユーザ数人がどういう順でエンドポイントにアクセスしてるか
- エンドポイントで何本のSQLが発行されているか

### 使えるチェックリストを用意しておく
- nginxのworker_connectionsが1024になっているか確認などの細かい粒度でチェックリストを作る

## アプリケーションの改修
- ボトルネックを計測し、そこを直す
- あてずっぽうでは思ったより上がらないことがある

### よくあるアンチパターン
- N+1クエリ、Joinの適用、キャッシュとか
- 練習しないとできない

## デプロイコマンドを整備する
- 一発で終わるようにシェルスクリプトなどで手順をまとめる
- ベンチマーク前の処理、ベンチマーク後の処理をまとめる

# 4時間目~
## 「やれることがない」への対処
- スキーマ、アクセスログ、メトリクス、マニュアルを読み直す

## 便利なツールを入れてみる（情報量が増える）
- netdata, new relicのAPM
- goならpprofなど、アプリの解析も大事

# 7時間目~
## ちゃんと掃除できるようにする
- MySQLの再起動
- New Relicを外す
- 便利なツールは便利だがリソースも食う

## 最後の一押し
- アクセスログの出力を止める
- 各種ログを全面的にとめる
- リソース監視系も全部止める

